version: '3.8'

services:

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: authserver-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  # PostgreSQL - AuthServer Database
  postgres_authserver:
    image: postgres:16
    container_name: authserver-postgres
    environment:
      POSTGRES_DB: AuthServerDb
      POSTGRES_USER: authserver
      POSTGRES_PASSWORD: authserver123
    ports:
      - "5433:5432"
    volumes:
      - postgres_authserver_data:/var/lib/postgresql/data
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U authserver -d AuthServerDb" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL - Product Database
  postgres_product:
    image: postgres:16
    container_name: product-postgres
    environment:
      POSTGRES_DB: ProductDb
      POSTGRES_USER: productadmin
      POSTGRES_PASSWORD: product123
    ports:
      - "5434:5432"
    volumes:
      - postgres_product_data:/var/lib/postgresql/data
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U productadmin -d ProductDb" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL - Customer Database
  postgres_customer:
    image: postgres:16
    container_name: customer-postgres
    environment:
      POSTGRES_DB: CustomerDb
      POSTGRES_USER: customeradmin
      POSTGRES_PASSWORD: customer123
    ports:
      - "5435:5432"
    volumes:
      - postgres_customer_data:/var/lib/postgresql/data
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U customeradmin -d CustomerDb" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL - Order Database
  postgres_order:
    image: postgres:16
    container_name: order-postgres
    environment:
      POSTGRES_DB: OrderDb
      POSTGRES_USER: orderadmin
      POSTGRES_PASSWORD: order123
    ports:
      - "5436:5432"
    volumes:
      - postgres_order_data:/var/lib/postgresql/data
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U orderadmin -d OrderDb" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PgAdmin
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: microservices-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@authserver.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - postgres_authserver
      - postgres_customer
      - postgres_product
      - postgres_order
    networks:
      - microservices-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/misc/ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  redis_data:
  postgres_authserver_data:
  postgres_customer_data:
  postgres_order_data:
  postgres_product_data:


networks:
  microservices-network:
    driver: bridge
